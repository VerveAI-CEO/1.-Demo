<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Matching System ‚Äî KI-gest√ºtzte Demo</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet" />
  <style>
    :root {
      /* Dark Mode (Standard) - changed to blue accents instead of yellow */
      --bg: #000000;
      --card-a: #111214;
      --card-b: #151718;
      --card-c: #1a1c1d;
      --card-border: rgba(255,255,255,0.04);
      --muted: #9aa4b2;
      /* Blue accents for dark mode */
      --accent: #2a6eff;
      --accent-2: #4d8aff;
      --accent-3: #0051d4;
      --text: #e6e6e6;
      --muted-2: #b7bdc3;
      --radius: 12px;
      --shadow-strong: 0 12px 40px rgba(0,0,0,0.8);
      --shadow-soft: 0 6px 18px rgba(0,0,0,0.6);
      --focus-glow: 0 0 16px rgba(42,110,255,0.12);
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* Light Mode - wird auf das html-Element angewendet */
    html.light-mode {
      --bg: #f8f9fa;
      --card-a: #ffffff;
      --card-b: #f8f9fa;
      --card-c: #f1f3f5;
      --card-border: rgba(0,0,0,0.08);
      --muted: #6c757d;
      /* keep light-mode accents as previously blue */
      --accent: #2a6eff;
      --accent-2: #4d8aff;
      --accent-3: #0051d4;
      --text: #212529;
      --muted-2: #495057;
      --shadow-strong: 0 12px 40px rgba(0,0,0,0.1);
      --shadow-soft: 0 6px 18px rgba(0,0,0,0.08);
      --focus-glow: 0 0 16px rgba(42,110,255,0.15);
    }
    
    /* ANIMATIONEN */
    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    
    @keyframes slideIn {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    @keyframes glow {
      0%, 100% { box-shadow: 0 0 20px var(--focus-glow); }
      50% { box-shadow: 0 0 30px var(--focus-glow); }
    }
    
    @keyframes gradientShift {
      0%, 100% { background-position: 0% 50%; opacity: 1; }
      50% { background-position: 100% 50%; opacity: 0.8; }
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-5px); }
    }
    
    @keyframes progressBar {
      0% { width: 0%; }
      100% { width: 100%; }
    }
    
    * { 
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    html, body { 
      height: 100%; 
      margin: 0; 
      background: var(--bg); 
      color: var(--text); 
      overflow-x: hidden;
      line-height: 1.6;
    }
    
    /* Animierter Hintergrund */
    .landing-bg {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      background: linear-gradient(-45deg, 
        rgba(42,110,255,0.05) 0%, 
        rgba(0,81,212,0.03) 25%, 
        rgba(0, 0, 0, 0) 50%, 
        rgba(77,138,255,0.02) 75%);
      background-size: 400% 400%;
      animation: gradientShift 20s ease infinite;
    }
    
    html.light-mode .landing-bg {
      background: linear-gradient(-45deg, 
        rgba(42, 110, 255, 0.05) 0%, 
        rgba(0, 81, 212, 0.03) 25%, 
        rgba(0, 0, 0, 0) 50%, 
        rgba(77, 138, 255, 0.02) 75%);
    }
    
    .container { 
      max-width: 1400px; 
      margin: 0 auto; 
      padding: 32px;
      animation: fadeIn 0.8s ease-out;
    }
    
    /* Kopfbereich */
    header.site-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 24px 32px;
      border-radius: 14px;
      background: var(--card-a);
      border: 1px solid var(--card-border);
      box-shadow: var(--shadow-strong);
      margin-bottom: 28px;
      backdrop-filter: blur(10px);
      animation: slideIn 0.6s ease-out;
      transition: all 0.3s ease;
    }
    
    header.site-header:hover {
      transform: translateY(-2px);
      box-shadow: 0 15px 50px rgba(0,0,0,0.9);
      border-color: rgba(42,110,255,0.1);
    }
    
    html.light-mode header.site-header:hover {
      border-color: rgba(42,110,255,0.1);
    }
    
    header.site-header h1 {
      margin: 0;
      font-size: 1.8rem;
      font-weight: 800;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    header.site-header .subtitle {
      font-size: 0.95rem;
      color: var(--muted-2);
      margin-top: 4px;
      font-weight: 400;
    }
    
    #adminLoginBtn {
      background: transparent;
      color: var(--accent);
      border: 1px solid var(--card-border);
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      font-size: 14px;
    }
    
    #adminLoginBtn:hover {
      transform: translateY(-2px);
      box-shadow: var(--focus-glow);
      background: rgba(42, 110, 255, 0.08);
    }
    
    html.light-mode #adminLoginBtn:hover {
      background: rgba(42, 110, 255, 0.08);
    }
    
    /* Theme Toggle Button */
    #themeToggle {
      background: transparent;
      color: var(--accent);
      border: 1px solid var(--card-border);
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      font-size: 14px;
      margin-left: 10px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    
    #themeToggle:hover {
      transform: translateY(-2px);
      box-shadow: var(--focus-glow);
      background: rgba(42, 110, 255, 0.08);
    }
    
    html.light-mode #themeToggle:hover {
      background: rgba(42, 110, 255, 0.08);
    }
    
    /* Verbesserte Hero Section */
    .landing-hero {
      display: grid;
      grid-template-columns: 1fr 400px;
      gap: 60px;
      align-items: start;
      min-height: 70vh;
      padding: 40px 0;
      animation: fadeIn 1s ease-out;
    }
    
    @media (max-width: 1000px) {
      .landing-hero {
        grid-template-columns: 1fr;
        gap: 40px;
      }
    }
    
    .landing-hero .promo {
      animation: slideIn 0.8s ease-out 0.2s both;
    }
    
    .chip {
      display: inline-block;
      padding: 8px 16px;
      border-radius: 6px;
      background: linear-gradient(135deg, rgba(42,110,255,0.12), rgba(77,138,255,0.06));
      color: var(--accent);
      font-weight: 600;
      margin-bottom: 20px;
      font-size: 13px;
      text-transform: uppercase;
      animation: float 3s ease-in-out infinite;
      border: 1px solid rgba(42,110,255,0.12);
    }
    
    html.light-mode .chip {
      background: linear-gradient(135deg, rgba(42, 110, 255, 0.15), rgba(0, 81, 212, 0.1));
      border: 1px solid rgba(42, 110, 255, 0.2);
    }
    
    .landing-hero .promo h2 {
      font-size: 3.2rem;
      line-height: 1.1;
      margin-bottom: 24px;
      font-weight: 800;
      background: linear-gradient(135deg, var(--text) 0%, var(--accent) 50%, var(--accent-3) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      letter-spacing: -1px;
    }
    
    .landing-hero .promo p {
      font-size: 1.15rem;
      line-height: 1.7;
      color: var(--muted-2);
      margin-bottom: 32px;
      max-width: 700px;
    }
    
    /* CTA-Buttons */
    .cta-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      margin-bottom: 40px;
    }
    
    .btn-primary {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 16px 28px;
      background: linear-gradient(135deg, var(--accent), var(--accent-3));
      color: var(--bg);
      border: none;
      border-radius: 8px;
      font-weight: 700;
      font-size: 16px;
      cursor: pointer;
      box-shadow: 0 10px 30px rgba(42,110,255,0.24);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }
    
    html.light-mode .btn-primary {
      box-shadow: 0 10px 30px rgba(42, 110, 255, 0.3);
    }
    
    .btn-primary::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.12), transparent);
      transition: left 0.7s ease;
    }
    
    .btn-primary:hover::before {
      left: 100%;
    }
    
    .btn-primary:hover {
      transform: translateY(-4px) scale(1.05);
      box-shadow: 0 20px 50px rgba(42,110,255,0.28);
    }
    
    html.light-mode .btn-primary:hover {
      box-shadow: 0 20px 50px rgba(42, 110, 255, 0.4);
    }
    
    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      margin: 40px 0;
    }
    
    .stat-card {
      background: var(--card-b);
      padding: 24px;
      border-radius: var(--radius);
      border: 1px solid var(--card-border);
      text-align: center;
      transition: all 0.3s ease;
      animation: fadeIn 0.8s ease-out;
    }
    
    .stat-card:hover {
      transform: translateY(-5px);
      border-color: rgba(42,110,255,0.12);
      background: var(--card-a);
    }
    
    html.light-mode .stat-card:hover {
      border-color: rgba(42, 110, 255, 0.12);
    }
    
    .stat-number {
      font-size: 2.5rem;
      font-weight: 800;
      background: linear-gradient(135deg, var(--accent), var(--accent-3));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      display: block;
      line-height: 1;
      margin-bottom: 8px;
    }
    
    .stat-label {
      font-size: 0.9rem;
      color: var(--muted-2);
      font-weight: 500;
    }
    
    /* Feature Grid */
    .feature-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 24px;
      margin-top: 40px;
    }
    
    .feature-card {
      background: var(--card-b);
      padding: 24px;
      border-radius: var(--radius);
      border: 1px solid var(--card-border);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: default;
      animation: fadeIn 0.8s ease-out;
      position: relative;
      overflow: hidden;
    }
    
    .feature-card:hover {
      transform: translateY(-8px);
      border-color: rgba(42,110,255,0.12);
      box-shadow: 0 15px 40px rgba(42,110,255,0.08);
    }
    
    html.light-mode .feature-card:hover {
      border-color: rgba(42, 110, 255, 0.12);
      box-shadow: 0 15px 40px rgba(42, 110, 255, 0.12);
    }
    
    .feature-icon { 
      font-size: 2.5rem; 
      margin-bottom: 12px; 
      display: inline-block;
      animation: bounce 2s ease-in-out infinite;
    }
    
    .feature-title { 
      font-size: 1.1rem; 
      font-weight: 700; 
      color: var(--accent); 
      margin-bottom: 8px; 
    }
    
    .feature-desc { 
      font-size: 0.9rem; 
      color: var(--muted-2); 
      line-height: 1.5; 
    }
    
    /* Rechte Spalte */
    .how-it-works {
      background: linear-gradient(135deg, rgba(42,110,255,0.06), rgba(0,81,212,0.03));
      padding: 32px;
      border-radius: var(--radius);
      border: 1px solid rgba(42,110,255,0.08);
      position: relative;
      overflow: hidden;
      animation: float 6s ease-in-out infinite;
      height: fit-content;
    }
    
    html.light-mode .how-it-works {
      background: linear-gradient(135deg, rgba(42,110,255,0.08), rgba(0,81,212,0.05));
      border-color: rgba(42,110,255,0.1);
    }
    
    .how-it-works h3 {
      margin: 0 0 20px 0;
      color: var(--text);
      font-size: 1.6rem;
      font-weight: 700;
    }
    
    .steps {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    
    .step {
      display: flex;
      align-items: flex-start;
      gap: 12px;
    }
    
    .step-number {
      background: linear-gradient(135deg, var(--accent), var(--accent-3));
      color: var(--bg);
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 14px;
      flex-shrink: 0;
    }
    
    .step-content h4 {
      margin: 0 0 4px 0;
      color: var(--accent);
      font-size: 1rem;
    }
    
    .step-content p {
      margin: 0;
      color: var(--muted-2);
      font-size: 0.9rem;
      line-height: 1.5;
    }
    
    /* Use Cases */
    .use-cases {
      margin-top: 60px;
      padding-top: 40px;
      border-top: 1px solid var(--card-border);
    }
    
    .use-case-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 24px;
      margin-top: 32px;
    }
    
    .use-case-card {
      background: var(--card-b);
      padding: 24px;
      border-radius: var(--radius);
      border: 1px solid var(--card-border);
      transition: all 0.3s ease;
    }
    
    .use-case-card:hover {
      transform: translateY(-5px);
      border-color: rgba(42,110,255,0.12);
    }
    
    html.light-mode .use-case-card:hover {
      border-color: rgba(42, 110, 255, 0.12);
    }
    
    /* KI-Analyse Anzeige */
    .ki-analysis {
      background: linear-gradient(135deg, rgba(42,110,255,0.05), rgba(0,81,212,0.03));
      padding: 20px;
      border-radius: var(--radius);
      border: 1px solid rgba(42,110,255,0.06);
      margin-top: 24px;
      display: none;
    }
    
    html.light-mode .ki-analysis {
      background: linear-gradient(135deg, rgba(42,110,255,0.05), rgba(0,81,212,0.03));
      border-color: rgba(42,110,255,0.1);
    }
    
    .ki-progress {
      height: 4px;
      background: rgba(255, 255, 255, 0.06);
      border-radius: 2px;
      overflow: hidden;
      margin: 12px 0;
    }
    
    html.light-mode .ki-progress {
      background: rgba(0, 0, 0, 0.08);
    }
    
    .ki-progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), var(--accent-3));
      width: 0%;
      animation: progressBar 1.5s ease-in-out infinite;
      border-radius: 2px;
    }
    
    .ki-log {
      font-family: 'Courier New', monospace;
      font-size: 13px;
      color: var(--muted);
      white-space: pre-wrap;
      margin-top: 12px;
      max-height: 200px;
      overflow-y: auto;
      background: rgba(0,0,0,0.3);
      padding: 12px;
      border-radius: 6px;
    }
    
    html.light-mode .ki-log {
      background: rgba(0,0,0,0.05);
      color: var(--muted-2);
    }
    
    /* Cards */
    .card {
      border-radius: var(--radius);
      padding: 28px;
      margin-top: 28px;
      border: 1px solid var(--card-border);
      box-shadow: var(--shadow-soft);
      animation: slideIn 0.6s ease-out;
      transition: transform 0.3s ease;
    }
    
    .card:hover {
      transform: translateY(-5px);
    }
    
    .card-a { background: var(--card-a); }
    .card-b { background: var(--card-b); }
    .card-c { background: var(--card-c); }
    
    h2, h3, h4 {
      margin: 0 0 16px 0;
      color: var(--accent);
      font-weight: 700;
    }
    
    h2 { font-size: 2rem; }
    h3 { font-size: 1.4rem; }
    h4 { font-size: 1.1rem; }
    
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--muted-2);
      font-size: 14px;
    }
    
    .form-group {
      margin-bottom: 20px;
      animation: fadeIn 0.5s ease-out;
    }
    
    input, textarea {
      width: 100%;
      padding: 14px 16px;
      border-radius: 8px;
      border: 1px solid var(--card-border);
      background: var(--card-b);
      color: var(--text);
      font-size: 15px;
      transition: all 0.2s ease;
      font-family: 'Inter', sans-serif;
    }
    
    input:focus, textarea:focus {
      outline: none;
      box-shadow: var(--focus-glow);
      border-color: var(--accent);
      transform: translateY(-2px);
    }
    
    textarea {
      min-height: 110px;
      resize: vertical;
      line-height: 1.5;
    }
    
    /* Custom Select */
    select.native-hidden {
      position: absolute !important;
      left: -9999px !important;
      width: 1px !important;
      height: 1px !important;
      opacity: 0 !important;
      pointer-events: none !important;
    }
    
    .custom-select {
      position: relative;
      user-select: none;
      display: inline-block;
      width: 100%;
      animation: fadeIn 0.5s ease-out;
    }
    
    .custom-select .sel-display {
      width: 100%;
      padding: 14px 40px 14px 16px;
      border-radius: 8px;
      background: var(--card-b);
      color: var(--text);
      border: 1px solid var(--card-border);
      cursor: pointer;
      font-size: 15px;
      transition: all 0.2s ease;
      text-align: left;
    }
    
    .custom-select .sel-display:focus {
      outline: none;
      box-shadow: var(--focus-glow);
      border-color: var(--accent);
      transform: translateY(-2px);
    }
    
    .custom-select .arrow {
      position: absolute;
      right: 16px;
      top: 50%;
      transform: translateY(-50%);
      width: 12px;
      height: 12px;
      pointer-events: none;
      color: var(--text);
      opacity: 0.9;
    }
    
    .custom-select .options {
      position: absolute;
      z-index: 9999;
      left: 0;
      right: 0;
      margin-top: 8px;
      border-radius: 8px;
      background: var(--card-a);
      border: 1px solid var(--card-border);
      box-shadow: var(--shadow-strong);
      max-height: 280px;
      overflow: auto;
      display: none;
      animation: slideIn 0.2s ease-out;
    }
    
    .custom-select .options.open {
      display: block;
    }
    
    .custom-select .option {
      padding: 12px 16px;
      color: var(--text);
      cursor: pointer;
      font-size: 14px;
      transition: background 0.15s ease;
    }
    
    .custom-select .option:hover,
    .custom-select .option.highlight {
      background: rgba(42, 110, 255, 0.08);
    }
    
    html.light-mode .custom-select .option:hover,
    html.light-mode .custom-select .option.highlight {
      background: rgba(42, 110, 255, 0.1);
    }
    
    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: linear-gradient(90deg, var(--accent), var(--accent-2));
      color: var(--bg);
      border: none;
      padding: 12px 20px;
      border-radius: 8px;
      font-weight: 700;
      font-size: 15px;
      cursor: pointer;
      box-shadow: 0 8px 20px rgba(42,110,255,0.06);
      transition: all 0.2s ease;
    }
    
    html.light-mode .btn {
      box-shadow: 0 8px 20px rgba(42, 110, 255, 0.06);
    }
    
    .btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 12px 25px rgba(42,110,255,0.12);
    }
    
    html.light-mode .btn:hover {
      box-shadow: 0 12px 25px rgba(42, 110, 255, 0.15);
    }
    
    .btn-ghost {
      background: transparent;
      color: var(--accent);
      border: 1px solid var(--card-border);
    }
    
    /* Participant Card */
    .participant-card {
      padding: 20px;
      border-radius: 10px;
      border: 1px solid var(--card-border);
      margin-bottom: 16px;
      background: var(--card-b);
      animation: slideIn 0.4s ease-out;
      transition: all 0.3s ease;
    }
    
    .participant-card:hover {
      transform: translateY(-3px);
      border-color: rgba(42,110,255,0.08);
    }
    
    html.light-mode .participant-card:hover {
      border-color: rgba(42, 110, 255, 0.1);
    }
    
    .role-badge {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 20px;
      background: var(--accent);
      color: var(--bg);
      font-size: 12px;
      font-weight: 700;
      margin-left: 10px;
    }
    
    .role-technical {
      background: var(--accent-3);
    }
    
    /* Spinner */
    .spinner {
      border: 4px solid rgba(255, 255, 255, 0.04);
      border-top: 4px solid var(--accent);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 12px;
    }
    
    html.light-mode .spinner {
      border: 4px solid rgba(0, 0, 0, 0.04);
    }
    
    /* Explanation box */
    .explanation {
      background: rgba(42,110,255,0.05);
      padding: 16px;
      border-radius: 8px;
      color: var(--muted-2);
      margin-top: 14px;
      white-space: pre-wrap;
      font-size: 14px;
      line-height: 1.6;
      animation: fadeIn 0.5s ease-out;
      border-left: 3px solid var(--accent);
    }
    
    html.light-mode .explanation {
      background: rgba(42, 110, 255, 0.05);
    }
    
    #toast {
      position: fixed;
      right: 24px;
      bottom: 24px;
      background: var(--card-a);
      color: var(--accent);
      padding: 16px 20px;
      border-radius: 8px;
      display: none;
      box-shadow: var(--shadow-strong);
      z-index: 9999;
      font-size: 14px;
      animation: slideIn 0.3s ease-out;
      border: 1px solid var(--card-border);
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .container { padding: 20px; }
      header.site-header { padding: 20px; }
      .landing-hero .promo h2 { font-size: 2.2rem; }
      .stats-grid { grid-template-columns: 1fr; }
      .feature-grid { grid-template-columns: 1fr; }
      .cta-buttons {
        flex-direction: column;
      }
      .btn-primary {
        width: 100%;
        justify-content: center;
      }
    }
    
    .label-muted {
      color: var(--muted-2);
      font-weight: 600;
      display: block;
      margin-bottom: 8px;
      font-size: 14px;
    }
    
    .small-note {
      font-size: 12px;
      color: var(--muted-2);
      margin-top: 6px;
    }
    
    .success-box {
      margin-top: 18px;
      padding: 14px 16px;
      background: linear-gradient(90deg, rgba(42,110,255,0.12), rgba(42,110,255,0.06));
      color: var(--bg);
      border-radius: 8px;
      font-weight: 700;
      display: none;
      font-size: 14px;
      animation: fadeIn 0.5s ease-out;
    }
    
    html.light-mode .success-box {
      background: linear-gradient(90deg, rgba(42, 110, 255, 0.12), rgba(42, 110, 255, 0.06));
    }
    
    /* Groups Output */
    .group-container {
      margin-top: 24px;
    }
    
    .group-card {
      background: var(--card-b);
      border: 1px solid var(--card-border);
      border-radius: var(--radius);
      padding: 20px;
      margin-bottom: 20px;
      animation: slideIn 0.5s ease-out;
    }
    
    .match-score {
      display: inline-block;
      padding: 4px 8px;
      background: rgba(42,110,255,0.08);
      color: var(--accent);
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
      margin-left: 10px;
    }
    
    html.light-mode .match-score {
      background: rgba(42, 110, 255, 0.08);
    }

    /* Admin password modal (styled like page) */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      padding: 20px;
    }
    .modal-overlay.open { display: flex; }
    .modal {
      width: 100%;
      max-width: 520px;
      background: var(--card-a);
      border: 1px solid var(--card-border);
      padding: 20px;
      border-radius: 12px;
      box-shadow: var(--shadow-strong);
      color: var(--text);
    }
    .modal h4 { margin-bottom: 8px; color:var(--accent) }
    .modal p { color: var(--muted-2); margin-bottom: 16px; }
    .modal .modal-actions { display:flex; gap:10px; justify-content:flex-end; margin-top:12px; }
    .modal input[type="password"] {
      width:100%;
      padding:12px;
      border-radius:8px;
      border:1px solid var(--card-border);
      background:var(--card-b);
      color:var(--text);
    }

    /* Large customer thank-you area */
    #customerThanksBig {
      display: none;
      border-radius: 12px;
      padding: 36px;
      text-align: center;
      background: linear-gradient(135deg, rgba(42,110,255,0.08), rgba(42,110,255,0.03));
      border: 1px solid rgba(42,110,255,0.08);
      margin-top: 18px;
    }
    #customerThanksBig h2 { font-size: 2rem; color: var(--accent); margin-bottom: 10px; }
    #customerThanksBig p { color: var(--muted-2); font-size: 1.05rem; }

    /* little helper for error-only behavior */
    .error-only {
      background: linear-gradient(135deg, rgba(255,50,50,0.06), rgba(255,50,50,0.02));
      border: 1px solid rgba(255,50,50,0.08);
      color: #ff8a8a;
      padding: 14px;
      border-radius: 8px;
    }
  </style>
</head>
<body>
<div class="landing-bg"></div>
<div class="container" id="app">
  <header class="site-header" role="banner">
    <div>
      <h1>Matching System</h1>
      <div class="subtitle">Intelligente Teilnehmerverwaltung & B2B-Matching</div>
    </div>
    <div>
      <button id="themeToggle" title="Design wechseln">
        <span id="themeIcon">üåô</span> <span id="themeText">Dark Mode</span>
      </button>
      <button id="adminLoginBtn" class="btn-ghost">Admin Area</button>
    </div>
  </header>

  <!-- START: Landing / Startseite -->
  <section id="landing" style="border:none;background:transparent;box-shadow:none">
    <div class="landing-hero">
      <div class="promo">
        <div class="chip">DEMO / PR√ÑSENTATION</div>
        <h2 id="landingTitle">Intelligentes B2B-Matching f√ºr Ihre Events</h2>
        <p>
          Erstellen Sie automatisch optimierte Teilnehmergruppen basierend auf Angebot und Nachfrage. 
          Perfekt f√ºr Fachmessen, Netzwerk-Events und Supplier-Matching. KI-gest√ºtzt, schnell und effizient.
        </p>
        
        <!-- Haupt-CTA Button -->
        <div class="cta-buttons">
          <button id="tryDemoBtn" class="btn-primary">
            <span style="animation: bounce 1s ease-in-out infinite">‚ñ∂</span> Demo jetzt starten
          </button>
        </div>
        
        <div class="stats-grid">
          <div class="stat-card">
            <span class="stat-number">94%</span>
            <span class="stat-label">Trefferquote</span>
          </div>
          <div class="stat-card">
            <span class="stat-number">3x</span>
            <span class="stat-label">Schneller</span>
          </div>
          <div class="stat-card">
            <span class="stat-number">24/7</span>
            <span class="stat-label">Verf√ºgbar</span>
          </div>
        </div>
        
        <div class="feature-grid">
          <div class="feature-card">
            <span class="feature-icon">‚óè</span>
            <div class="feature-title">Smart Matching</div>
            <div class="feature-desc">KI-basierte Gruppierung nach Angebot & Nachfrage</div>
          </div>
          <div class="feature-card">
            <span class="feature-icon">‚óè</span>
            <div class="feature-title">Blitzschnell</div>
            <div class="feature-desc">Ergebnisse in Sekunden, nicht Stunden</div>
          </div>
          <div class="feature-card">
            <span class="feature-icon">‚óè</span>
            <div class="feature-title">Export Ready</div>
            <div class="feature-desc">CSV, JSON & Druck-Ansicht inklusive</div>
          </div>
          <div class="feature-card">
            <span class="feature-icon">‚óè</span>
            <div class="feature-title">KI-Erkl√§rungen</div>
            <div class="feature-desc">Automatische Begr√ºndung f√ºr jede Gruppe</div>
          </div>
        </div>
        
        <!-- KI-Analyse Demo -->
        <div class="ki-analysis" id="kiAnalysis">
          <h4>KI-Analyse l√§uft...</h4>
          <div class="ki-progress">
            <div class="ki-progress-bar"></div>
          </div>
          <div class="ki-log" id="kiLog">
Analyse gestartet...
- Lade Teilnehmerdaten
- Analysiere Angebote
- Bewerte Nachfragen
- Berechne Match-Scores
- Optimiere Gruppen
          </div>
        </div>
        
        <!-- Use Cases -->
        <div class="use-cases">
          <h3>Einsatzbereiche</h3>
          <div class="use-case-grid">
            <div class="use-case-card">
              <h4>Maschinenbau</h4>
              <p>Lieferanten finden, Kooperationen bilden, Innovationstreiber identifizieren</p>
            </div>
            <div class="use-case-card">
              <h4>Fachmessen</h4>
              <p>Besucher vernetzen, Matchmaking automatisieren, Follow-ups vereinfachen</p>
            </div>
            <div class="use-case-card">
              <h4>Gro√üunternehmen</h4>
              <p>Interne Abteilungen vernetzen, Wissenstransfer f√∂rdern, Synergien nutzen</p>
            </div>
          </div>
        </div>
      </div>
      
      <!-- RECHTE SPALTE: Wie es funktioniert -->
      <div class="visual">
        <div class="how-it-works">
          <h3>Wie es funktioniert</h3>
          <div class="steps">
            <div class="step">
              <div class="step-number">1</div>
              <div class="step-content">
                <h4>Teilnehmer erfassen</h4>
                <p>Erfassen Sie Angebote und Nachfragen Ihrer Teilnehmer √ºber einfache Formulare.</p>
              </div>
            </div>
            <div class="step">
              <div class="step-number">2</div>
              <div class="step-content">
                <h4>KI-Analyse</h4>
                <p>Unsere KI analysiert automatisch die Komplementarit√§t zwischen Teilnehmern.</p>
              </div>
            </div>
            <div class="step">
              <div class="step-number">3</div>
              <div class="step-content">
                <h4>Optimale Gruppen</h4>
                <p>Erhalten Sie optimierte Gruppen basierend auf inhaltlicher Passung.</p>
              </div>
            </div>
            <div class="step">
              <div class="step-number">4</div>
              <div class="step-content">
                <h4>Export & Follow-up</h4>
                <p>Exportieren Sie Ergebnisse oder drucken Sie direkt f√ºr Ihr Event.</p>
              </div>
            </div>
          </div>
          
          <div style="margin-top:30px; padding-top:20px; border-top:1px solid rgba(42,110,255,0.08)">
            <div style="color:var(--muted-2);font-size:14px;margin-bottom:12px">
              <strong>Vorteile im √úberblick:</strong>
            </div>
            <div style="display:flex;flex-direction:column;gap:10px">
              <div style="display:flex;align-items:center;gap:8px">
                <div style="width:8px;height:8px;background:var(--accent);border-radius:50%"></div>
                <span style="font-size:13px;color:var(--muted-2)">Reduziert Vorbereitungszeit um 80%</span>
              </div>
              <div style="display:flex;align-items:center;gap:8px">
                <div style="width:8px;height:8px;background:var(--accent-3);border-radius:50%"></div>
                <span style="font-size:13px;color:var(--muted-2)">Erh√∂ht Networking-Erfolg signifikant</span>
              </div>
              <div style="display:flex;align-items:center;gap:8px">
                <div style="width:8px;height:8px;background:var(--accent);border-radius:50%"></div>
                <span style="font-size:13px;color:var(--muted-2)">Keine manuelle Zuordnung n√∂tig</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
  <!-- END Landing -->

  <!-- MAIN: App (hidden until demo/tool open) -->
  <main id="mainApp" style="display:none">
    <!-- Participation Form -->
    <section id="customerSection" class="card card-a" aria-label="Teilnahmeformular">
      <h2>Participation Form</h2>
      <form id="customerForm" novalidate autocomplete="off">
        <div class="form-group">
          <label class="label-muted" for="c-name">Name (Last, First)</label>
          <input id="c-name" name="c-name" placeholder="Doe, John" required />
          <div class="small-note">Bsp.: "John Doe" oder "Doe, John"</div>
        </div>
        <div class="form-group">
          <label for="c-role">Role</label>
          <select id="c-role" class="native-hidden" name="c-role" required>
            <option value="">Please choose</option>
            <option value="commercial">Commercial</option>
            <option value="technical">Technical</option>
          </select>
          <div id="c-role-custom" class="custom-select" data-target="c-role" tabindex="0" role="listbox" aria-haspopup="listbox"></div>
        </div>
        <div class="form-group">
          <label for="c-factory">Factory / Location</label>
          <input id="c-factory" name="c-factory" placeholder="Factory name or city" required />
        </div>
        <div class="form-group">
          <label for="c-offer">We offer</label>
          <textarea id="c-offer" name="c-offer" placeholder="Short description..." required></textarea>
        </div>
        <div class="form-group">
          <label for="c-seek">We seek</label>
          <textarea id="c-seek" name="c-seek" placeholder="Who/what are you looking for?" required></textarea>
        </div>
        <div class="form-group">
          <label for="c-key-takeaways">Key Takeaways</label>
          <textarea id="c-key-takeaways" name="c-key-takeaways" placeholder="Optional"></textarea>
        </div>
        <div class="form-group">
          <label for="c-contact-partners">Contact Partners</label>
          <textarea id="c-contact-partners" name="c-contact-partners" placeholder="Optional"></textarea>
        </div>
        <button class="btn" id="cust-submit" type="submit">Submit</button>
      </form>

      <div id="customerSuccess" class="success-box" role="status" aria-live="polite">‚úì Danke ‚Äî Eintrag empfangen</div>

      <!-- large thank-you shown after submit; prevents re-submission unless reopened via admin -->
      <div id="customerThanksBig" aria-live="polite">
        <h2>Danke! Dein Eintrag wurde empfangen.</h2>
        <p>Wir haben deine Angaben gespeichert. Eine weitere Teilnahme ist deaktiviert ‚Äî bei Bedarf bitte Admin kontaktieren.</p>
      </div>
    </section>
    
    <div style="text-align:center;margin-top:20px;color:var(--muted-2);font-size:14px">
      Klicke <strong style="color:var(--accent)">Admin Area</strong> oben zum Verwalten.
    </div>

    <!-- Admin Section -->
    <section id="adminSection" style="display:none">
      <header>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
          <div>
            <h3 style="margin:0;color:var(--accent)">Admin Dashboard</h3>
            <div style="color:var(--muted-2);margin-top:8px;font-size:14px">Management & grouping</div>
          </div>
          <div style="display:flex;gap:8px">
            <button id="reopen-registration" class="btn-ghost" title="Erneute Registrierung erlauben">Reopen registration</button>
            <button id="adminLogoutBtn" class="btn-ghost">Log out</button>
          </div>
        </div>
      </header>

      <div class="card card-b">
        <h3>Add Participants</h3>
        <form id="participant-form" novalidate autocomplete="off">
          <div class="form-group">
            <label class="label-muted" for="name-admin">Name (Last, First)</label>
            <input id="name-admin" name="name-admin" placeholder="Doe, John" required />
            <div class="small-note">alternativ: "John Doe"</div>
          </div>
          <div class="form-group">
            <label for="role-admin">Role</label>
            <select id="role-admin" class="native-hidden" name="role-admin" required>
              <option value="">Please choose</option>
              <option value="commercial">Commercial</option>
              <option value="technical">Technical</option>
            </select>
            <div id="role-admin-custom" class="custom-select" data-target="role-admin" tabindex="0" role="listbox"></div>
          </div>
          <div class="form-group">
            <label for="factory-admin">Factory / Location</label>
            <input id="factory-admin" name="factory-admin" required />
          </div>
          <div class="form-group">
            <label for="we-offer-admin">We offer</label>
            <textarea id="we-offer-admin" name="we-offer-admin" required></textarea>
          </div>
          <div class="form-group">
            <label for="we-seek-admin">We seek</label>
            <textarea id="we-seek-admin" name="we-seek-admin" required></textarea>
          </div>
          <div class="form-group">
            <label for="key-takeaways-admin">Key Takeaways</label>
            <textarea id="key-takeaways-admin" name="key-takeaways-admin"></textarea>
          </div>
          <div class="form-group">
            <label for="contact-partners-admin">Contact Partners</label>
            <textarea id="contact-partners-admin" name="contact-partners-admin"></textarea>
          </div>
          <button id="admin-add-btn" class="btn" type="submit">Add participant</button>
        </form>
        <div id="adminSuccess" class="success-box" role="status" aria-live="polite">‚úì Erfolgreich hinzugef√ºgt</div>
      </div>

      <div class="card card-c" style="margin-top:28px">
        <h3 style="color:var(--accent)">Teilnehmerliste</h3>
        <div id="participants-container" style="margin-top:16px"></div>
      </div>

      <div class="card card-a" style="margin-top:28px">
        <h3 style="color:var(--accent)">Groups & Actions</h3>
        <div style="display:flex;gap:14px;flex-wrap:wrap;margin-top:16px">
          <button id="create-groups" class="btn">Generate Groups</button>
          <button id="export-csv" class="btn">Export CSV</button>
          <button id="export-json" class="btn">Export JSON</button>
          <button id="print-results" class="btn">Print</button>
        </div>
        
        <div class="alt-panel" style="margin-top:20px;display:flex;align-items:center;gap:14px;flex-wrap:wrap">
          <label for="alt-count" style="color:var(--muted-2);font-size:14px">Alternatives</label>
          <input id="alt-count" type="number" min="1" max="3" value="2" style="width:90px" />
          <select id="alt-preference" class="native-hidden">
            <option value="offers">Prefer offers</option>
            <option value="balanced">Balanced</option>
            <option value="seeks">Prefer seeks</option>
          </select>
          <div id="alt-preference-custom" class="custom-select" data-target="alt-preference" tabindex="0" role="listbox" style="width:200px"></div>
          <button id="generate-alternatives" class="btn">Generate Alternatives</button>
        </div>
        
        <div id="loading" class="loading" style="display:none;margin-top:20px">
          <div class="spinner" aria-hidden="true"></div>
          <div style="color:var(--muted-2);font-size:14px">KI analysiert Teilnehmer...</div>
        </div>
        
        <div id="results-container" style="margin-top:20px"></div>
      </div>
    </section>
  </main>

  <div id="toast" role="status" aria-live="polite"></div>

  <!-- Admin password modal (custom) -->
  <div id="adminModal" class="modal-overlay" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" role="document">
      <h4>Admin Login</h4>
      <p>Bitte Admin-Passwort eingeben, um auf das Dashboard zuzugreifen.</p>
      <input id="adminPwdInput" type="password" placeholder="Passwort" aria-label="Admin Passwort" />
      <div class="modal-actions">
        <button id="adminCancel" class="btn-ghost">Abbrechen</button>
        <button id="adminSubmit" class="btn">Anmelden</button>
      </div>
      <div id="adminModalError" style="margin-top:10px;display:none;color:#ff9b9b;font-weight:700"></div>
    </div>
  </div>

</div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
  "use strict";
  
  // ========== KONFIGURATION ==========
  const OPENAI_API_KEY = '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';
  const ADMIN_PASSWORD = 'admin123';
  const firebaseConfig = {
    apiKey: "AIzaSyCoNXOOdXyrDU43I3oaAQhNzD-sW9qlIk4",
    authDomain: "werkleiter-mat.firebaseapp.com",
    projectId: "werkleiter-mat",
    storageBucket: "werkleiter-mat.firebasestorage.app",
    messagingSenderId: "274812390256",
    appId: "1:274812390256:web:181e0a87484ec283a95db5"
  };
  
  // ========== INITIALISIERUNG ==========
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  
  // ========== THEME MANAGEMENT ==========
  function initTheme() {
    const savedTheme = localStorage.getItem('theme');
    
    if (!savedTheme) {
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      setTheme(prefersDark ? 'dark' : 'light');
    } else {
      setTheme(savedTheme);
    }
  }

  function setTheme(theme) {
    if (theme === 'light') {
      document.documentElement.classList.add('light-mode');
    } else {
      document.documentElement.classList.remove('light-mode');
    }
    localStorage.setItem('theme', theme);
    updateThemeButton(theme);
  }

  function toggleTheme() {
    const isLight = document.documentElement.classList.contains('light-mode');
    setTheme(isLight ? 'dark' : 'light');
  }

  function updateThemeButton(theme) {
    const themeIcon = document.getElementById('themeIcon');
    const themeText = document.getElementById('themeText');
    
    if (theme === 'light') {
      themeIcon.textContent = '‚òÄÔ∏è';
      themeText.textContent = 'Light Mode';
    } else {
      themeIcon.textContent = 'üåô';
      themeText.textContent = 'Dark Mode';
    }
  }
  
  // ========== DOM ELEMENTE ==========
  const $ = id => document.getElementById(id);
  const els = {
    landing: $('landing'),
    tryDemoBtn: $('tryDemoBtn'),
    mainApp: $('mainApp'),
    adminLoginBtn: $('adminLoginBtn'),
    adminSection: $('adminSection'),
    customerSection: $('customerSection'),
    customerForm: $('customerForm'),
    customerSuccess: $('customerSuccess'),
    customerThanksBig: $('customerThanksBig'),
    participantForm: $('participant-form'),
    participantsContainer: $('participants-container'),
    createGroupsBtn: $('create-groups'),
    exportCSVBtn: $('export-csv'),
    exportJSONBtn: $('export-json'),
    printBtn: $('print-results'),
    generateAlternativesBtn: $('generate-alternatives'),
    altCountInput: $('alt-count'),
    altPreferenceSelect: $('alt-preference'),
    resultsContainer: $('results-container'),
    loading: $('loading'),
    toast: $('toast'),
    adminLogoutBtn: $('adminLogoutBtn'),
    adminSuccess: $('adminSuccess'),
    kiAnalysis: $('kiAnalysis'),
    kiLog: $('kiLog'),
    themeToggle: $('themeToggle'),
    // modal
    adminModal: $('adminModal'),
    adminPwdInput: $('adminPwdInput'),
    adminSubmit: $('adminSubmit'),
    adminCancel: $('adminCancel'),
    adminModalError: $('adminModalError'),
    reopenRegistrationBtn: $('reopen-registration')
  };

  // ========== GLOBALE VARIABLEN ==========
  let participants = [];
  let customerSubmitted = false;
  const recentlyAdded = new Map();

  // ========== HILFSFUNKTIONEN ==========
  function showToast(msg, ms=4000){
    const t = els.toast;
    t.innerText = msg;
    t.style.display = 'block';
    clearTimeout(t._hid);
    t._hid = setTimeout(()=> t.style.display = 'none', ms);
  }
  
  function escapeHtml(s){ 
    return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); 
  }
  
  function download(filename, text, mime='text/plain'){ 
    const blob = new Blob([text],{type:mime}); 
    const a = document.createElement('a'); 
    a.href = URL.createObjectURL(blob); 
    a.download = filename; 
    a.click(); 
    setTimeout(()=> URL.revokeObjectURL(a.href), 2000); 
  }
  
  function fetchWithTimeout(url, options={}, timeout=15000){ 
    return new Promise((resolve,reject)=>{ 
      const controller = new AbortController(); 
      const timer = setTimeout(()=>{
        controller.abort(); 
        reject(new Error('Timeout'));
      }, timeout); 
      fetch(url, {...options, signal: controller.signal})
        .then(res=>{ 
          clearTimeout(timer); 
          resolve(res); 
        })
        .catch(err=>{ 
          clearTimeout(timer); 
          reject(err); 
        }); 
    }); 
  }
  
  async function retryAsync(fn, attempts=3, initialDelay=500){ 
    let lastErr; 
    for (let i=0;i<attempts;i++){ 
      try{ 
        return await fn(); 
      } catch(e){ 
        lastErr=e; 
        const jitter = Math.floor(Math.random()*100)-50; 
        const delay = Math.max(0, initialDelay*(2**i)+jitter); 
        await new Promise(r=>setTimeout(r,delay)); 
      } 
    }
    throw lastErr; 
  }
  
  function showYouAreIn(element){
    element.style.transition = '';
    element.style.opacity = '1';
    element.style.display = 'block';
    setTimeout(()=>{
      element.style.transition = 'opacity 420ms ease';
      element.style.opacity = '0';
      setTimeout(()=> element.style.display = 'none', 430);
    }, 1800);
  }
  
  function showBadgeForId(id, duration = 6000){
    const card = document.getElementById('pc_' + id);
    if (!card) return;
    if (card.querySelector('.you-are-in-badge')) {
      const b = card.querySelector('.you-are-in-badge');
      b.classList.add('show');
      return;
    }
    const badge = document.createElement('span');
    badge.className = 'you-are-in-badge';
    badge.innerText = 'You are in';
    const strong = card.querySelector('strong');
    if (strong) strong.insertAdjacentElement('afterend', badge);
    requestAnimationFrame(()=> badge.classList.add('show'));
    if (recentlyAdded.has(id)) clearTimeout(recentlyAdded.get(id));
    const t = setTimeout(()=>{
      badge.classList.remove('show');
      setTimeout(()=> { if (badge.parentNode) badge.parentNode.removeChild(badge); }, 260);
      recentlyAdded.delete(id);
    }, duration);
    recentlyAdded.set(id, t);
  }
  
  function escapeHtmlSafe(s){ 
    return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); 
  }
  
  function capitalizeWords(str){ 
    return String(str || '').split(/\s+/).map(w => { 
      if (!w) return ''; 
      return w.charAt(0).toUpperCase() + w.slice(1).toLowerCase(); 
    }).join(' '); 
  }
  
  function normalizeNameInput(input){
    if (!input || typeof input !== 'string') return { storedName: '', displayName: '' };
    let s = input.trim();
    if (s.includes(',')) {
      const parts = s.split(',').map(p => p.trim()).filter(Boolean);
      const last = capitalizeWords(parts[0]);
      const first = parts[1] ? capitalizeWords(parts[1]) : '';
      const stored = first ? `${last}, ${first}` : last;
      const display = first ? `${first} ${last}` : last;
      return { storedName: stored, displayName: display };
    }
    const parts = s.split(/\s+/).filter(Boolean);
    if (parts.length === 1) {
      const name = capitalizeWords(parts[0]);
      return { storedName: name, displayName: name };
    }
    const last = capitalizeWords(parts.slice(-1)[0]);
    const first = capitalizeWords(parts.slice(0, -1).join(' '));
    const stored = `${last}, ${first}`;
    const display = `${first} ${last}`;
    return { storedName: stored, displayName: display };
  }
  
  function normalizeParticipant(raw){
    const nameObj = normalizeNameInput(raw.name || '');
    const d = {
      name: nameObj.storedName || '',
      displayName: nameObj.displayName || '',
      role: String(raw.role || '').trim(),
      factory: String(raw.factory || '').trim(),
      weOffer: String(raw.weOffer || '').trim(),
      weSeek: String(raw.weSeek || '').trim(),
      keyTakeaways: String(raw.keyTakeaways || '').trim(),
      contactPartners: String(raw.contactPartners || '').trim()
    };
    if (!d.name || d.name.length < 1) throw new Error('Name too short');
    if (!['commercial','technical'].includes(d.role)) throw new Error('Invalid role');
    if (!d.factory) throw new Error('Factory required');
    if (!d.weOffer) throw new Error('"We offer" required');
    if (!d.weSeek) throw new Error('"We seek" required');
    return d;
  }

  // ========== CUSTOM SELECT COMPONENT ==========
  class CustomSelect {
    constructor(container) {
      this.container = container;
      this.targetId = container.dataset.target;
      this.select = document.getElementById(this.targetId);
      if (!this.select) {
        console.error('CustomSelect: Target select not found:', this.targetId);
        return;
      }
      
      this.options = Array.from(this.select.options).map(o => ({ 
        value: o.value, 
        label: o.text, 
        disabled: o.disabled 
      }));
      this.selectedIndex = this.select.selectedIndex >= 0 ? this.select.selectedIndex : 0;
      this.open = false;
      this._build();
    }
    
    _build(){
      this.display = document.createElement('button');
      this.display.className = 'sel-display';
      this.display.type = 'button';
      this.display.setAttribute('aria-expanded','false');
      this.display.setAttribute('aria-haspopup','listbox');
      this.display.tabIndex = 0;
      
      this.arrow = document.createElement('span');
      this.arrow.className = 'arrow';
      this.arrow.innerHTML = '‚ñº';
      this.display.appendChild(this.arrow);
      this.container.appendChild(this.display);
      
      this.optionsPanel = document.createElement('div');
      this.optionsPanel.className = 'options';
      this.optionsPanel.setAttribute('role','listbox');
      this.container.appendChild(this.optionsPanel);
      
      this._renderOptions();
      this._updateDisplay();
      
      this.display.addEventListener('click', (e)=>{ 
        e.stopPropagation(); 
        this.toggle(); 
      });
      this.display.addEventListener('keydown', (e)=> this._onKeydown(e));
      document.addEventListener('click', ()=> this.close());
    }
    
    _renderOptions(){
      this.optionsPanel.innerHTML = '';
      this.options.forEach((opt, idx)=>{
        const div = document.createElement('div');
        div.className = 'option' + (opt.disabled ? ' disabled' : '');
        div.setAttribute('data-value', opt.value);
        div.setAttribute('data-index', idx);
        div.textContent = opt.label;
        div.tabIndex = -1;
        div.addEventListener('click', (e)=>{ 
          e.stopPropagation(); 
          if (opt.disabled) return; 
          this.selectIndex(idx); 
          this.close(); 
        });
        div.addEventListener('mouseover', ()=> this._highlight(idx));
        this.optionsPanel.appendChild(div);
      });
    }
    
    _updateDisplay(){
      const sel = this.options[this.selectedIndex];
      const existingLabel = this.display.querySelector('.label-text');
      if (existingLabel) existingLabel.remove();
      
      const span = document.createElement('span');
      span.className = 'label-text';
      span.style.marginRight = '8px';
      span.textContent = sel ? sel.label : '';
      this.display.insertBefore(span, this.arrow);
      
      this.select.selectedIndex = this.selectedIndex;
      this.select.dispatchEvent(new Event('change', { bubbles: true }));
    }
    
    toggle(){ this.open ? this.close() : this.openPanel(); }
    
    openPanel(){ 
      this.open = true; 
      this.optionsPanel.classList.add('open'); 
      this.display.setAttribute('aria-expanded','true'); 
      this._highlight(this.selectedIndex); 
    }
    
    close(){ 
      this.open = false; 
      this.optionsPanel.classList.remove('open'); 
      this.display.setAttribute('aria-expanded','false'); 
      this._clearHighlight(); 
    }
    
    selectIndex(idx){ 
      if (idx < 0 || idx >= this.options.length) return; 
      if (this.options[idx].disabled) return; 
      this.selectedIndex = idx; 
      this._updateDisplay(); 
    }
    
    _highlight(idx){ 
      this._clearHighlight(); 
      const opt = this.optionsPanel.querySelector(`[data-index="${idx}"]`); 
      if (opt) { 
        opt.classList.add('highlight'); 
        opt.scrollIntoView({ block: 'nearest' }); 
      } 
      this._highlighted = idx; 
    }
    
    _clearHighlight(){ 
      const prev = this.optionsPanel.querySelector('.option.highlight'); 
      if (prev) prev.classList.remove('highlight'); 
      this._highlighted = -1; 
    }
    
    _onKeydown(e){
      if (e.key === 'Enter' || e.key === ' ') { 
        e.preventDefault(); 
        this.toggle(); 
        return; 
      }
      if (e.key === 'ArrowDown') { 
        e.preventDefault(); 
        if (!this.open) { 
          this.openPanel(); 
          return; 
        } 
        const next = Math.min((this._highlighted>=0?this._highlighted:this.selectedIndex)+1, this.options.length-1); 
        this._highlight(next); 
      }
      if (e.key === 'ArrowUp') { 
        e.preventDefault(); 
        if (!this.open) { 
          this.openPanel(); 
          return; 
        } 
        const prev = Math.max((this._highlighted>=0?this._highlighted:this.selectedIndex)-1, 0); 
        this._highlight(prev); 
      }
      if (e.key === 'Escape') { 
        this.close(); 
      }
      if (e.key === 'Enter' && this.open && this._highlighted>=0) { 
        this.selectIndex(this._highlighted); 
        this.close(); 
      }
    }
  }
  
  function enhanceSelects() {
    const customEls = document.querySelectorAll('.custom-select');
    customEls.forEach(c => {
      if (c.dataset.enhanced) return;
      new CustomSelect(c);
      c.dataset.enhanced = 'true';
    });
  }

  // ========== FIRESTORE FUNKTIONEN ==========
  function subscribeParticipants() {
    try {
      db.collection('participants').orderBy('created','asc').onSnapshot(snap=>{
        participants = [];
        snap.forEach(doc=>{
          const d = doc.data() || {};
          participants.push({
            id: doc.id,
            name: d.name || '',
            displayName: d.displayName || '',
            role: d.role || '',
            factory: d.factory || '',
            weOffer: d.weOffer || '',
            weSeek: d.weSeek || '',
            keyTakeaways: d.keyTakeaways || '',
            contactPartners: d.contactPartners || '',
            created: d.created || null
          });
        });
        renderParticipantsList();
      }, err => { 
        console.error('Firestore listener error', err); 
        showToast('Firestore error: ' + (err.message || 'unknown')); 
      });
    } catch(e){ 
      console.error('subscribeParticipants error', e); 
      showToast('DB connection error'); 
    }
  }
  
  function renderParticipantsList(){
    const c = els.participantsContainer; 
    c.innerHTML = '';
    if (!participants.length) { 
      c.innerHTML = '<p style="color:var(--muted-2)">No participants</p>'; 
      return; 
    }
    
    const frag = document.createDocumentFragment();
    participants.forEach(p=>{
      const card = document.createElement('div'); 
      card.className='participant-card';
      const roleLabel = p.role === 'commercial' ? 'Commercial' : (p.role === 'technical' ? 'Technical' : 'Unknown');
      const roleClass = p.role === 'commercial' ? 'role-badge' : 'role-badge role-technical';
      const cardId = 'pc_' + p.id;
      card.id = cardId;
      const nameToShow = p.displayName || p.name;
      
      card.innerHTML = `
        <strong style="color:var(--accent)">${escapeHtmlSafe(nameToShow)}</strong>
        <span class="${roleClass}">${roleLabel}</span>
        <div style="margin-top:12px;color:var(--muted-2);font-size:13px"><strong>Factory / Location:</strong> ${escapeHtmlSafe(p.factory)}</div>
        <div style="color:var(--muted-2);font-size:13px"><strong>We offer:</strong> ${escapeHtmlSafe(p.weOffer)}</div>
        <div style="color:var(--muted-2);font-size:13px"><strong>We seek:</strong> ${escapeHtmlSafe(p.weSeek)}</div>
        <div style="color:var(--muted-2);font-size:13px"><strong>Key Takeaways:</strong> ${escapeHtmlSafe(p.keyTakeaways||'-')}</div>
        <div style="color:var(--muted-2);font-size:13px"><strong>Contact Partners:</strong> ${escapeHtmlSafe(p.contactPartners||'-')}</div>
        <div style="margin-top:14px">
          <button class="btn-ghost remove-btn" style="padding:6px 12px;font-size:13px">Remove</button>
        </div>
      `;
      
      card.querySelector('.remove-btn').addEventListener('click', ()=>{
        if (!confirm(`Remove "${nameToShow}"?`)) return;
        db.collection('participants').doc(p.id).delete()
          .then(()=> showToast('Removed'))
          .catch(err=>{ 
            console.error(err); 
            showToast('Error removing'); 
          });
      });
      
      frag.appendChild(card);
      if (recentlyAdded.has(p.id)) setTimeout(()=> showBadgeForId(p.id), 50);
    });
    c.appendChild(frag);
  }

  // ========== GRUPPIERUNGSLOGIK ==========
  function tokens(text){ 
    if (!text) return new Set(); 
    return new Set(String(text).toLowerCase()
      .replace(/[^\w\s√§√∂√º√ü]/g,' ')
      .split(/\s+/)
      .filter(Boolean)); 
  }
  
  const WEIGHT_OFFER = 3.0, WEIGHT_SEEK = 1.0;
  
  function pairScore(a,b){
    const aOffer = tokens(a.weOffer), aSeek = tokens(a.weSeek);
    const bOffer = tokens(b.weOffer), bSeek = tokens(b.weSeek);
    const inter = (s,t) => {
      let c = 0; 
      for(const x of s) if(t.has(x)) c++; 
      return c;
    };
    return WEIGHT_OFFER * inter(aOffer, bSeek) + 
           WEIGHT_OFFER * inter(aSeek, bOffer) + 
           inter(aOffer, bOffer) + 
           0.5 * inter(aSeek, bSeek);
  }
  
  function generateGroupsDeterministic(allParticipants, numGroups = 4){
    const valid = allParticipants.filter(p => p && p.name);
    if(!valid.length) return [];
    
    numGroups = Math.max(1, Math.min(valid.length, Math.floor(Number(numGroups) || 4)));
    const groups = Array.from({length: numGroups}, (_, i) => ({
      title: `Group ${i+1}`, 
      members: []
    }));
    
    const pool = valid.slice();
    const targetSize = Math.ceil(pool.length / numGroups);
    
    // Seed each group with one strong candidate
    for(let g = 0; g < numGroups; g++){
      if(!pool.length) break;
      let bestIdx = 0, bestVal = -Infinity;
      for(let i = 0; i < pool.length; i++){
        const p = pool[i];
        const val = (p.weOffer || '').split(/\s+/).filter(Boolean).length + 
                   (p.weSeek || '').split(/\s+/).filter(Boolean).length;
        if(val > bestVal){
          bestVal = val;
          bestIdx = i;
        }
      }
      groups[g].members.push(pool.splice(bestIdx,1)[0]);
    }
    
    // Fill remaining by greedy best-fit
    while(pool.length){
      let best = {gIdx: -1, pIdx: -1, score: -Infinity};
      for(let gi = 0; gi < groups.length; gi++){
        if(groups[gi].members.length >= targetSize) continue;
        for(let pi = 0; pi < pool.length; pi++){
          let score = 0;
          for(const m of groups[gi].members) score += pairScore(m, pool[pi]);
          if(score > best.score){ 
            best = {gIdx: gi, pIdx: pi, score}; 
          }
        }
      }
      
      if(best.gIdx === -1 || best.score <= 0){
        // No positive fit: distribute remaining evenly
        let gi = 0;
        while(pool.length){
          groups[gi % groups.length].members.push(pool.shift());
          gi++;
        }
        break;
      } else {
        groups[best.gIdx].members.push(pool.splice(best.pIdx,1)[0]);
      }
    }
    
    return groups;
  }

  // ========== OPENAI ERKL√ÑRUNG (KORRIGIERT) ==========
  async function fetchGPTExplanation(payloadText){
    // If the key isn't present (or is the placeholder), treat as an error ‚Äî we will not render groups if AI is not available.
    if (!OPENAI_API_KEY || OPENAI_API_KEY === 'FRONTEND_OPENAI_KEY') {
      throw new Error('OpenAI API key not available');
    }
    
    const prompt = `Explain concisely why the following grouping(s) are sensible based on participants' "We Offer" and "We Seek".\n\n${payloadText}\n\nProvide a short clear explanation for each grouping.`;
    const body = JSON.stringify({ 
      model: 'gpt-3.5-turbo', 
      messages: [{role: 'user', content: prompt}], 
      max_tokens: 300, 
      temperature: 0.6 
    });
    
    async function call() {
      const resp = await fetchWithTimeout(
        'https://api.openai.com/v1/chat/completions', 
        { 
          method: 'POST', 
          headers: { 
            'Content-Type': 'application/json', 
            'Authorization': `Bearer ${OPENAI_API_KEY}` 
          }, 
          body 
        }, 
        30000  // Erh√∂htes Timeout
      );
      
      if (!resp.ok) {
        // Verbesserte Fehlerbehandlung
        let errorMessage = `OpenAI API error (${resp.status})`;
        try {
          const errorText = await resp.text();
          if (errorText) {
            const errorJson = JSON.parse(errorText);
            if (errorJson.error && errorJson.error.message) {
              errorMessage = errorJson.error.message;
            } else {
              errorMessage = errorText;
            }
          }
        } catch (parseErr) {
          console.error('Error parsing OpenAI error response:', parseErr);
        }
        console.error('OpenAI API error details:', {
          status: resp.status,
          statusText: resp.statusText,
          message: errorMessage
        });
        throw new Error(errorMessage);
      }
      
      const j = await resp.json();
      const explanation = j.choices?.[0]?.message?.content?.trim();
      
      if (!explanation) {
        console.error('OpenAI response malformed:', j);
        throw new Error('OpenAI response malformed');
      }
      
      return explanation;
    }
    
    return retryAsync(call, 3, 1000);
  }

  // ========== FORM SUBMISSION HANDLERS ==========
  // Customer Form Submit
  els.customerForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    if (customerSubmitted) {
      showToast('Registrierung bereits gesendet. Nur Admin kann erneut √∂ffnen.');
      return;
    }
    const btn = $('cust-submit');
    try {
      btn.disabled = true;
      const entry = normalizeParticipant({
        name: $('c-name').value,
        role: (document.getElementById('c-role').value || '').trim(),
        factory: $('c-factory').value,
        weOffer: $('c-offer').value,
        weSeek: $('c-seek').value,
        keyTakeaways: $('c-key-takeaways').value,
        contactPartners: $('c-contact-partners').value
      });
      
      const payload = { 
        ...entry, 
        displayName: entry.displayName, 
        created: firebase.firestore.FieldValue.serverTimestamp() 
      };
      
      const ref = await db.collection('participants').add(payload);
      // show large thank you and prevent further submissions from public UI
      customerSubmitted = true;
      els.customerForm.style.display = 'none';
      els.customerThanksBig.style.display = 'block';
      recentlyAdded.set(ref.id, setTimeout(() => recentlyAdded.delete(ref.id), 6000));
      setTimeout(() => showBadgeForId(ref.id), 120);
      // ensure small success box hidden (we use big one)
      els.customerSuccess.style.display = 'none';
    } catch (err) {
      showToast(err.message || 'Error registering');
    } finally {
      btn.disabled = false;
    }
  });

  // Admin Form Submit
  els.participantForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const btn = $('admin-add-btn');
    try {
      btn.disabled = true;
      const p = normalizeParticipant({
        name: $('name-admin').value,
        role: (document.getElementById('role-admin').value || '').trim(),
        factory: $('factory-admin').value,
        weOffer: $('we-offer-admin').value,
        weSeek: $('we-seek-admin').value,
        keyTakeaways: $('key-takeaways-admin').value,
        contactPartners: $('contact-partners-admin').value
      });
      
      const payload = { 
        ...p, 
        displayName: p.displayName, 
        created: firebase.firestore.FieldValue.serverTimestamp() 
      };
      
      const ref = await db.collection('participants').add(payload);
      showYouAreIn(els.adminSuccess);
      recentlyAdded.set(ref.id, setTimeout(() => recentlyAdded.delete(ref.id), 6000));
      setTimeout(() => showBadgeForId(ref.id), 120);
      els.participantForm.reset();
    } catch (err) {
      showToast(err.message || 'Error adding');
    } finally {
      btn.disabled = false;
    }
  });

  // ========== ADMIN CONTROLS (CUSTOM MODAL) ==========
  function openAdminModal(){
    els.adminModal.classList.add('open');
    els.adminModal.setAttribute('aria-hidden','false');
    els.adminModalError.style.display = 'none';
    els.adminPwdInput.value = '';
    setTimeout(()=> els.adminPwdInput.focus(), 100);
  }
  function closeAdminModal(){
    els.adminModal.classList.remove('open');
    els.adminModal.setAttribute('aria-hidden','true');
  }

  els.adminLoginBtn.addEventListener('click', () => {
    openAdminModal();
  });

  els.adminCancel.addEventListener('click', (e) => {
    e.preventDefault();
    closeAdminModal();
  });

  els.adminSubmit.addEventListener('click', (e) => {
    e.preventDefault();
    const pwd = els.adminPwdInput.value || '';
    if (pwd !== ADMIN_PASSWORD){
      els.adminModalError.innerText = 'Falsches Passwort';
      els.adminModalError.style.display = 'block';
      els.adminPwdInput.focus();
      showToast('Wrong password');
      return;
    }
    closeAdminModal();
    enterAdmin();
  });

  els.adminPwdInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      els.adminSubmit.click();
    }
  });

  function enterAdmin(){ 
    els.adminSection.style.display = 'block'; 
    els.customerSection.style.display = 'none'; 
    els.adminLoginBtn.style.display = 'none'; 
    setTimeout(() => enhanceSelects(), 100);
  }
  
  function leaveAdmin(){ 
    els.adminSection.style.display = 'none'; 
    els.customerSection.style.display = customerSubmitted ? 'none' : 'block'; 
    els.adminLoginBtn.style.display = 'inline-block'; 
    setTimeout(() => enhanceSelects(), 100);
  }

  els.adminLogoutBtn.addEventListener('click', () => { 
    leaveAdmin(); 
    showToast('Logged out'); 
  });

  // allow admin to re-open registration for customers
  els.reopenRegistrationBtn.addEventListener('click', () => {
    customerSubmitted = false;
    els.customerForm.style.display = 'block';
    els.customerThanksBig.style.display = 'none';
    showToast('Customer registration re-opened');
  });

  // ========== CREATE GROUPS (AI REQUIRED) ==========
  els.createGroupsBtn.addEventListener('click', async () => {
    if (!participants || participants.length < 4){ 
      showToast('At least 4 participants required.'); 
      return; 
    }
    
    els.loading.style.display = 'block';
    els.resultsContainer.innerHTML = '';
    
    try {
      const groups = generateGroupsDeterministic(participants, 4);
      if (!groups.length){ 
        els.resultsContainer.innerHTML = '<p style="color:var(--muted-2)">No groups generated</p>'; 
        els.loading.style.display = 'none'; 
        return; 
      }
      
      // Build detailed text for OpenAI first. If OpenAI fails we will NOT render groups (per request).
      const groupingText = groups.map(g => {
        const memberDetails = g.members.map(m => 
          `${m.name} (${m.role}): Offers "${(m.weOffer||'').substring(0, 120)}", Seeks "${(m.weSeek||'').substring(0, 120)}"`
        ).join('\n  ');
        return `${g.title}:\n  ${memberDetails}`;
      }).join('\n\n');

      // Attempt to get explanation from OpenAI. If this fails, do nothing except show an error.
      let explanation;
      try {
        explanation = await fetchGPTExplanation(groupingText);
      } catch (aiErr) {
        console.error('AI explanation failed, aborting group display:', aiErr);
        // Show concise error only, no groups
        els.resultsContainer.innerHTML = `<div class="error-only">Fehler: Die KI-Erkl√§rung konnte nicht erzeugt werden. Gruppen wurden nicht angezeigt.</div>`;
        showToast('AI explanation failed ‚Äî groups not displayed');
        return;
      }
      
      // If explanation succeeded, render groups along with the explanation (same explanation used for all groups)
      groups.forEach(g => {
        const box = document.createElement('div'); 
        box.className = 'group-card';
        const members = g.members.map(m => escapeHtmlSafe(m.name)).join(', ');
        
        box.innerHTML = `
          <h3 style="color:var(--accent)">${escapeHtmlSafe(g.title)}</h3>
          <div style="color:var(--muted-2);margin-top:8px"><strong>Members:</strong> ${members || '-'}</div>
          <div class="explanation">${escapeHtmlSafe(explanation)}</div>
        `;
        
        els.resultsContainer.appendChild(box);
      });
      
      showToast('Groups created successfully!');
      
    } catch(e) {
      console.error('Error creating groups:', e);
      els.resultsContainer.innerHTML = `<div class="error-only">Fehler beim Erstellen der Gruppen: ${escapeHtmlSafe(e.message || 'Unknown error')}</div>`;
      showToast('Groups creation failed: ' + (e.message || 'Unknown error'));
    } finally {
      els.loading.style.display = 'none';
    }
  });

  // ========== GENERATE ALTERNATIVES (AI REQUIRED) ==========
  els.generateAlternativesBtn.addEventListener('click', async () => {
    if (!participants || participants.length < 4){ 
      showToast('At least 4 participants required.'); 
      return; 
    }
    
    els.loading.style.display = 'block';
    els.resultsContainer.innerHTML = '';
    
    const count = Math.min(3, Math.max(1, Number(els.altCountInput.value) || 2));
    
    try {
      // We'll generate variants and request explanations for each - if any AI call fails, abort and show an error only.
      const allAlternatives = [];
      for (let i = 0; i < count; i++){
        const arr = participants.slice(); 
        arr.sort((a,b) => ((a.name.charCodeAt(0)+i+1) % 5) - ((b.name.charCodeAt(0)+i+1) % 5)); 
        const v = generateGroupsDeterministic(arr, 4);
        allAlternatives.push(v);
      }
      
      // Build combined explanations: call AI per alternative sequentially but abort on first failure (no partial display).
      const allExplanations = [];
      for (let i = 0; i < allAlternatives.length; i++){
        const v = allAlternatives[i];
        const altText = v.map(g => {
          const memberDetails = g.members.map(m => 
            `${m.name}: Offers "${(m.weOffer||'').substring(0, 80)}", Seeks "${(m.weSeek||'').substring(0, 80)}"`
          ).join(', ');
          return `${g.title}: ${memberDetails}`;
        }).join('\n');
        
        try {
          const explanation = await fetchGPTExplanation(altText);
          allExplanations.push(explanation);
        } catch(aiErr) {
          console.error('AI failed for alternatives:', aiErr);
          els.resultsContainer.innerHTML = `<div class="error-only">Fehler: Die KI-Erkl√§rung f√ºr Alternativen konnte nicht erzeugt werden. Keine Alternativen angezeigt.</div>`;
          showToast('AI explanation failed ‚Äî alternatives not displayed');
          return;
        }
      }
      
      // If we reached here, all explanations are available -> render all alternatives with their explanations
      allAlternatives.forEach((v, idx) => {
        const box = document.createElement('div'); 
        box.className = 'group-card';
        box.innerHTML = `<h3 style="color:var(--accent)">Alternative ${idx+1}</h3>`;
        
        v.forEach(g => {
          const div = document.createElement('div');
          div.style.color = 'var(--muted-2)';
          div.style.marginTop = '8px';
          div.innerHTML = `<strong>${escapeHtmlSafe(g.title)}</strong>: ${escapeHtmlSafe(g.members.map(m => m.name).join(', ') || '-')}`;
          box.appendChild(div);
        });
        
        const exp = document.createElement('div');
        exp.className = 'explanation';
        exp.innerText = allExplanations[idx] || 'No explanation generated.';
        box.appendChild(exp);
        els.resultsContainer.appendChild(box);
      });
      
      showToast(`${count} alternatives generated!`);
    } catch(e) {
      console.error('Error generating alternatives:', e);
      els.resultsContainer.innerHTML = `<div class="error-only">Fehler beim Generieren der Alternativen: ${escapeHtmlSafe(e.message || 'Unknown error')}</div>`;
      showToast('Error generating alternatives: ' + (e.message || 'Unknown error'));
    } finally {
      els.loading.style.display = 'none';
    }
  });

  // ========== EXPORT FUNCTIONS ==========
  function participantsToCSV(arr){
    const cols = ['id', 'name', 'role', 'factory', 'weOffer', 'weSeek', 'keyTakeaways', 'contactPartners'];
    const esc = v => `"${String(v||'').replace(/"/g,'""')}"`;
    return [cols.join(',')].concat(arr.map(p => cols.map(c => esc(p[c])).join(','))).join('\n');
  }

  els.exportCSVBtn.addEventListener('click', () => { 
    const csv = participantsToCSV(participants); 
    download('participants.csv', csv, 'text/csv'); 
    showToast('CSV downloaded'); 
  });

  els.exportJSONBtn.addEventListener('click', () => { 
    download('participants.json', JSON.stringify(participants, null, 2), 'application/json'); 
    showToast('JSON downloaded'); 
  });

  els.printBtn.addEventListener('click', () => {
    const participantsDiv = document.getElementById('participants-container');
    if (!participantsDiv) return;
    
    const printWindow = window.open('', '', 'width=800,height=600');
    printWindow.document.write('<html><head><title>Participants List</title></head><body>');
    printWindow.document.write('<h2>Participants</h2>');
    printWindow.document.write('<div>');
    
    const parser = new DOMParser();
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = participantsDiv.innerHTML;
    
    tempDiv.querySelectorAll('.remove-btn').forEach(btn => btn.remove());
    
    printWindow.document.write(tempDiv.innerHTML);
    printWindow.document.write('</div>');
    printWindow.document.write('</body></html>');
    printWindow.document.close();
    printWindow.focus();
    printWindow.print();
    printWindow.close();
  });

  // ========== DEMO FUNKTIONEN ==========
  const DEMO_PARTICIPANTS = [
    { 
      id: 'd1', 
      name: 'Meyer, Anna', 
      displayName: 'Anna Meyer', 
      role: 'commercial', 
      factory: 'Bremen', 
      weOffer: 'Packaging solutions, co-packing for food industry, sustainable materials', 
      weSeek: 'New suppliers for labels and packaging, logistics partners, automation solutions',
      keyTakeaways: 'Focus on food-grade materials, sustainability certificates required',
      contactPartners: 'procurement@company.com' 
    },
    { 
      id: 'd2', 
      name: 'Schmidt, Karl', 
      displayName: 'Karl Schmidt', 
      role: 'technical', 
      factory: 'M√ºnchen', 
      weOffer: 'Automation retrofits for production lines, robotics integration, Industry 4.0 consulting', 
      weSeek: 'Pilot customers for retrofit solutions, partnerships with machine builders, investment opportunities',
      keyTakeaways: 'Focus on SME market, ROI within 2 years',
      contactPartners: 'tech@automation.de' 
    },
    { 
      id: 'd3', 
      name: 'Lopez, Maria', 
      displayName: 'Maria Lopez', 
      role: 'commercial', 
      factory: 'Wien', 
      weOffer: 'Custom packaging design, brand development, international distribution', 
      weSeek: 'Production partners in DACH region, e-commerce specialists, sustainable material suppliers',
      keyTakeaways: 'Growing demand for eco-friendly packaging',
      contactPartners: 'sales@packaging.at' 
    },
    { 
      id: 'd4', 
      name: 'Nguyen, Tom', 
      displayName: 'Tom Nguyen', 
      role: 'technical', 
      factory: 'Berlin', 
      weOffer: 'Robotics integration, AI quality control systems, production optimization', 
      weSeek: 'Integration partners, funding for R&D, collaboration with universities',
      keyTakeaways: 'Strong focus on AI and machine learning',
      contactPartners: 'innovation@techlab.de' 
    },
    { 
      id: 'd5', 
      name: 'Fischer, Lea', 
      displayName: 'Lea Fischer', 
      role: 'commercial', 
      factory: 'Dortmund', 
      weOffer: 'Ingredient sourcing for food industry, quality control services, supply chain optimization', 
      weSeek: 'Co-packers for snacks and beverages, organic suppliers, logistics optimization',
      keyTakeaways: 'Increasing demand for organic and regional products',
      contactPartners: 'sourcing@foodgroup.com' 
    }
  ];

  async function loadDemoParticipants(){
    try {
      // L√∂sche vorhandene Demo-Daten
      const existing = participants.filter(p => p.id && p.id.startsWith('d'));
      for (const p of existing) {
        if (p.id) {
          await db.collection('participants').doc(p.id).delete();
        }
      }
      
      // F√ºge Demo-Daten hinzu
      for (const demo of DEMO_PARTICIPANTS) {
        const payload = { 
          ...demo, 
          created: firebase.firestore.FieldValue.serverTimestamp() 
        };
        await db.collection('participants').doc(demo.id).set(payload);
      }
      
      showToast('Demo-Teilnehmer geladen', 2000);
    } catch (err) {
      console.error('Error loading demo participants:', err);
      showToast('Error loading demo data');
    }
  }

  // ========== LANDING PAGE BUTTONS ==========
  els.tryDemoBtn.addEventListener('click', async () => {
    els.landing.style.display = 'none';
    els.mainApp.style.display = 'block';
    await loadDemoParticipants();
    setTimeout(() => enhanceSelects(), 100);
  });

  // ========== INITIALISIERUNG ==========
  document.addEventListener('DOMContentLoaded', () => {
    // Theme initialisieren
    initTheme();
    
    // Theme Toggle Event
    els.themeToggle.addEventListener('click', toggleTheme);
    
    // Feature Cards animieren
    document.querySelectorAll('.feature-card').forEach((card, i) => {
      card.style.animationDelay = `${i * 0.1}s`;
    });
    
    // Stat Cards animieren
    document.querySelectorAll('.stat-card').forEach((card, i) => {
      card.style.animationDelay = `${i * 0.2}s`;
    });
    
    subscribeParticipants();
    
    // Willkommensnachricht
    setTimeout(() => {
      showToast('Willkommen beim Matching System!', 3000);
    }, 1000);

    // enhance selects early
    setTimeout(() => enhanceSelects(), 200);
  });
</script>
</body>
</html>
